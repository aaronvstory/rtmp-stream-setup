name: PR Agent - Autonomous Review & Improve

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  pr_agent_job:
    runs-on: ubuntu-latest
    if: ${{ github.event.sender.type != 'Bot' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run PR Agent - Auto Review & Improve
        uses: Codium-ai/pr-agent@main
        env:
          # API Configuration
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Model Configuration: GPT-4.1 mini for efficiency, GPT-5 for complex PRs
          config.model: "openai/gpt-4.1-mini"
          config.fallback_models: '["openai/gpt-5"]'

          # Automation Toggles (modern dot notation)
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"

          # Push Trigger: DISABLED by default (reduces noise/cost)
          github_action_config.handle_push_trigger: "false"

          # Review Configuration
          pr_reviewer.fail_on_major_issues: "true"
          pr_reviewer.inline_comments: "true"

          # Improve (fix suggestions) Configuration
          pr_code_suggestions.num_code_suggestions: "5"
          pr_code_suggestions.commitable_code_suggestions: "true"

      - name: Notify on Review Completion
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // Post a summary notification after PR-Agent completes
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸ¤– **PR-Agent Review Complete**\n\nI've analyzed this PR for:\n- âœ… Code quality and bugs\n- ðŸ”’ Security vulnerabilities\n- ðŸ’¡ Suggested improvements\n- ðŸš¨ Blocking issues\n\nCheck the PR-Agent comments above for details. You can:\n- Click "Apply suggestion" on any code suggestions\n- Comment \`/review\` to re-run the review\n- Comment \`/improve\` for additional suggestions\n- Comment \`/describe\` to regenerate the PR description`
              });
            } catch (error) {
              console.log('Note: Could not post summary comment (may already exist)');
            }
